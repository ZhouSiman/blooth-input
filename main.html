<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è®¾å¤‡åˆ†æµç›‘æ§ç³»ç»Ÿ (æœ¬åœ°è°ƒè¯•ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face {
            font-family: 'JetBrains Mono';
            src: url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #0f172a; color: #cbd5e1; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .device-card { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border-width: 2px; min-height: 180px; }
        .device-active { border-color: #10b981; background: rgba(16, 185, 129, 0.15); transform: translateY(-4px); }
        .event-row { animation: slideIn 0.2s ease-out; border-bottom: 1px solid #1e293b; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        .scrollbar-hidden::-webkit-scrollbar { width: 4px; }
        .scrollbar-hidden::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .input-locked {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            animation: border-pulse 2s infinite;
        }
        @keyframes border-pulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); }
            50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.1); }
        }

        .logic-step { @apply relative flex flex-col items-center p-3 rounded-xl border border-slate-700 bg-slate-800/30 text-center; }
        .logic-arrow { @apply flex items-center justify-center text-slate-600; }

        .msg-label { @apply px-1 py-0.5 rounded text-[8px] font-black uppercase mr-2; }
        .label-tx { @apply bg-blue-600 text-white; }
        .label-rx { @apply bg-purple-600 text-white; }
        .label-sys { @apply bg-slate-700 text-slate-300; }

        .status-pill { @apply flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-slate-900 border border-slate-800 text-[9px] font-bold; }

        .dot-flashing {
            position: relative; width: 6px; height: 6px; border-radius: 5px; background-color: #10b981; color: #10b981;
            animation: dot-flashing 1s infinite linear alternate; animation-delay: 0.5s;
        }
        .dot-flashing::before, .dot-flashing::after { content: ""; display: inline-block; position: absolute; top: 0; }
        .dot-flashing::before { left: -10px; width: 6px; height: 6px; border-radius: 5px; background-color: #10b981; animation: dot-flashing 1s infinite linear alternate; animation-delay: 0s; }
        .dot-flashing::after { left: 10px; width: 6px; height: 6px; border-radius: 5px; background-color: #10b981; animation: dot-flashing 1s infinite linear alternate; animation-delay: 1s; }
        @keyframes dot-flashing { 0% { background-color: #10b981; } 50%, 100% { background-color: rgba(16, 185, 129, 0.2); } }
    </style>
</head>
<body class="min-h-screen p-4">

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b border-slate-800 pb-6">
            <div>
                <h1 class="text-2xl font-black text-white flex items-center gap-3">
                    <span class="bg-blue-600 text-white px-2 py-0.5 rounded text-sm uppercase tracking-wider text-[10px]">LOCAL PRO</span> 
                    æ™ºèƒ½å¤šåè®®åˆ†æµç³»ç»Ÿ
                </h1>
                <p class="text-slate-500 text-xs mt-1 text-balance">
                    <span class="text-emerald-400 font-bold">æœ¬åœ°è°ƒè¯•æ¨¡å¼</span> | æ£€æµ‹åˆ°åœ°å€: <span id="current-origin-label" class="text-blue-400 font-mono italic">loading...</span>
                </p>
            </div>
            
            <div id="env-checker" class="flex flex-wrap gap-2 text-white">
                <div class="status-pill" id="st-https">
                    <div class="w-1.5 h-1.5 rounded-full bg-slate-600 text-white"></div> <span>å®‰å…¨ä¸Šä¸‹æ–‡</span>
                </div>
                <div class="status-pill" id="st-bt">
                    <div class="w-1.5 h-1.5 rounded-full bg-slate-600 text-white text-white text-white"></div> <span>è“ç‰™ API</span>
                </div>
                <div class="status-pill" id="st-persistent">
                    <div class="w-1.5 h-1.5 rounded-full bg-slate-600 text-white text-white text-white"></div> <span>æŒä¹…æƒé™</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 text-white text-white">
            
            <div class="lg:col-span-3 space-y-4 text-white text-white text-white">
                
                <section class="bg-blue-700 p-5 rounded-2xl border border-blue-500 shadow-xl shadow-blue-900/30 relative overflow-hidden text-white text-white text-white">
                    <h2 class="text-xs font-bold uppercase mb-4 tracking-widest flex justify-between items-center text-blue-100 text-white">
                        è“ç‰™åè®®é…ç½® (Pos 3)
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" /></svg>
                    </h2>
                    
                    <div class="space-y-4 text-white">
                        <div class="space-y-2 text-white">
                            <div>
                                <label class="block text-[9px] text-blue-200 font-bold mb-1 uppercase tracking-wider text-white">Service UUID</label>
                                <input type="text" id="gatt-service-uuid" value="275ce3d8-b906-4475-8dd7-76af0db742bf" class="w-full bg-blue-800 border border-blue-400/30 rounded p-2 text-[10px] font-mono outline-none focus:border-white transition-all shadow-inner text-white">
                            </div>
                            <div>
                                <label class="block text-[9px] text-blue-200 font-bold mb-1 uppercase tracking-wider text-white">Characteristic UUID</label>
                                <input type="text" id="gatt-char-uuid" value="78b028ce-affd-4967-ab9e-dc336c8c94e7" class="w-full bg-blue-800 border border-blue-400/30 rounded p-2 text-[10px] font-mono outline-none focus:border-white transition-all shadow-inner text-white text-white">
                            </div>
                        </div>

                        <div class="space-y-2 pt-2 border-t border-blue-600/50 text-white">
                            <button onclick="smartFilteredScan()" class="w-full py-2.5 bg-emerald-500 hover:bg-emerald-400 text-white text-xs font-black rounded-xl transition-all shadow-md active:scale-95 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                æŒ‰ç…§é…ç½®è¿æ¥
                            </button>

                            <button onclick="quickReconnect()" id="reconnect-btn" class="w-full py-2 bg-blue-900/50 hover:bg-blue-800 text-blue-100 text-[10px] font-black rounded-xl transition-all border border-blue-400/30 active:scale-95 flex items-center justify-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                                å¿«é€Ÿé‡è¿ (å·²æˆæƒè®¾å¤‡)
                            </button>
                            
                            <button onclick="discoveryModeScan()" class="w-full py-2.5 bg-blue-500 hover:bg-blue-400 text-white text-[10px] font-black rounded-xl transition-all shadow-md active:scale-95 flex items-center justify-center gap-2 border border-blue-400/50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                æ¢æµ‹æ¨¡å¼ (æŸ¥çœ‹ UUID)
                            </button>
                        </div>

                        <div id="env-alert-box" class="p-3 bg-amber-950/40 rounded-xl border border-amber-500/30 hidden">
                            <p class="text-[8px] text-amber-300 leading-relaxed font-bold">
                                ğŸ’¡ ç¯å¢ƒè°ƒè¯•å»ºè®®ï¼š<br>
                                å¦‚æœé‡è¿å¤±è´¥ï¼Œè¯·ç¡®ä¿ï¼š<br>
                                1. ç›´æ¥åœ¨ Chrome ä¸­æ‰“å¼€ localhost é“¾æ¥ï¼Œè€Œéåœ¨ IDE çš„é¢„è§ˆçª—å£å†…ã€‚<br>
                                2. Chrome ç‰ˆæœ¬ > 103 ä¸”å·²å®Œæˆè¿‡è‡³å°‘ä¸€æ¬¡æ‰‹åŠ¨é…å¯¹ã€‚
                            </p>
                        </div>
                    </div>
                </section>

                <section class="bg-slate-800/50 p-5 rounded-2xl border border-slate-700 shadow-xl text-white">
                    <h2 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest flex justify-between items-center text-white">
                        HID ç­¾ååˆ†æµ
                        <span class="text-[9px] text-slate-600 font-mono">POS 1/2</span>
                    </h2>
                    <div class="space-y-4 text-white">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 font-bold text-white text-white">æ‰«ææª A å‰ç¼€</label>
                            <input type="text" id="sig-a" value="[DEV1]" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm outline-none focus:ring-1 focus:ring-blue-500 font-mono text-white transition-all text-white">
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1 font-bold text-white text-white">æ‰«ææª B å‰ç¼€</label>
                            <input type="text" id="sig-b" value="[DEV2]" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-2.5 text-sm outline-none focus:ring-1 focus:ring-blue-500 font-mono text-white transition-all text-white text-white">
                        </div>
                    </div>
                </section>

                <section class="bg-slate-800/50 p-5 rounded-2xl border border-slate-700 shadow-lg text-white">
                    <h2 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest flex justify-between items-center text-white">
                        æ€»çº¿é”å®š
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" text="blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>
                    </h2>
                    <div class="flex items-center justify-between p-2 bg-slate-900/50 rounded-lg text-white text-white">
                        <span class="text-[10px] text-slate-300 font-bold text-white">å¼ºè¡Œé”å®šç„¦ç‚¹</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="lock-focus-toggle" class="sr-only peer" checked>
                            <div class="w-7 h-4 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </section>
            </div>

            <div class="lg:col-span-9 space-y-6 text-white text-white text-white">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-white text-white text-white">
                    <div id="card-a" class="device-card bg-slate-800/40 p-4 rounded-xl border-slate-700 relative overflow-hidden flex flex-col shadow-lg text-white text-white">
                        <div class="flex justify-between items-center mb-3 text-white text-white">
                            <span class="text-[10px] font-black uppercase text-emerald-500 tracking-wider">POS 1: æ‰«ææª A å½•å…¥</span>
                            <button onclick="clearPosData('a')" class="text-[8px] text-slate-600 hover:text-slate-400">é‡ç½®</button>
                        </div>
                        <div class="flex-grow space-y-1">
                            <div class="text-[10px] text-slate-500 font-bold uppercase text-white">è¾“å…¥å†å²ï¼š</div>
                            <div id="val-a" class="max-h-32 overflow-y-auto scrollbar-hidden text-sm font-mono text-white break-all whitespace-normal">-</div>
                        </div>
                        <div class="mt-3 text-[9px] text-slate-600 border-t border-slate-800 pt-2 flex justify-between items-center text-white text-white">
                            <span id="ts-a">--:--:--</span>
                            <button onclick="analyzeData('a')" class="text-emerald-600 hover:underline">âœ¨ AI å®¡è®¡</button>
                        </div>
                    </div>

                    <div id="card-b" class="device-card bg-slate-800/40 p-4 rounded-xl border-slate-700 relative overflow-hidden flex flex-col shadow-lg text-white">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-black uppercase text-blue-400 tracking-wider">POS 2: æ‰«ææª B å½•å…¥</span>
                            <button onclick="clearPosData('b')" class="text-[8px] text-slate-600 hover:text-slate-400 text-white">é‡ç½®</button>
                        </div>
                        <div class="flex-grow space-y-1 text-white text-white">
                            <div class="text-[10px] text-slate-500 font-bold uppercase text-white">è¾“å…¥å†å²ï¼š</div>
                            <div id="val-b" class="max-h-32 overflow-y-auto scrollbar-hidden text-sm font-mono text-white break-all whitespace-normal">-</div>
                        </div>
                        <div class="mt-3 text-[9px] text-slate-600 border-t border-slate-800 pt-2 flex justify-between items-center text-white text-white text-white">
                            <span id="ts-b">--:--:--</span>
                            <button onclick="analyzeData('b')" class="text-blue-500 hover:underline text-white text-white">âœ¨ AI å®¡è®¡</button>
                        </div>
                    </div>

                    <div id="card-c" class="device-card bg-slate-800/40 p-4 rounded-xl border-slate-700 relative overflow-hidden flex flex-col border-blue-500/20 shadow-lg text-white text-white text-white">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-black uppercase text-amber-500 tracking-wider">POS 3: è“ç‰™åè®®æµ</span>
                            <button onclick="clearPosData('c')" class="text-[8px] text-slate-600 hover:text-slate-400">é‡ç½®</button>
                        </div>
                        <div class="flex-grow space-y-1">
                            <div class="text-[10px] text-slate-500 font-bold uppercase text-white text-white text-white text-white text-white">è¾“å…¥å†å²ï¼š</div>
                            <div id="val-c" class="max-h-32 overflow-y-auto scrollbar-hidden text-sm font-mono text-white break-all whitespace-normal text-white">-</div>
                        </div>
                        <div class="mt-2 p-1.5 bg-blue-900/20 rounded border border-blue-800/30 text-white">
                            <p class="text-[7px] text-blue-300 uppercase font-black opacity-60">å½“å‰åè®®</p>
                            <p id="current-protocol-info" class="text-[7px] text-blue-400 truncate font-mono">Service: æœªæ¿€æ´»</p>
                        </div>
                        <div class="mt-3 text-[9px] text-slate-600 border-t border-slate-800 pt-2 flex justify-between items-center text-white text-white">
                            <span id="ts-c">--:--:--</span>
                            <button onclick="analyzeData('c')" class="text-amber-600 hover:underline">âœ¨ AI å®¡è®¡</button>
                        </div>
                    </div>

                    <div id="card-d" class="device-card bg-slate-800/40 p-4 rounded-xl border-slate-700 relative overflow-hidden flex flex-col shadow-lg text-white">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-black uppercase text-slate-300 tracking-wider text-opacity-80">POS 4: æ™®é€šé”®ç›˜æ•²å‡»</span>
                            <button onclick="clearPosData('d')" class="text-[8px] text-slate-600 hover:text-slate-400 text-white">é‡ç½®</button>
                        </div>
                        <div class="flex-grow space-y-1 text-white">
                            <div class="text-[10px] text-slate-500 font-bold uppercase text-white text-white">è¾“å…¥å†å²ï¼š</div>
                            <div id="val-d" class="max-h-32 overflow-y-auto scrollbar-hidden text-sm font-mono text-white break-all whitespace-normal text-white">-</div>
                        </div>
                        <div class="mt-3 text-[9px] text-slate-600 border-t border-slate-800 pt-2 flex justify-between items-center text-white text-white text-white text-white">
                            <span id="ts-d">--:--:--</span>
                            <button onclick="analyzeData('d')" class="text-slate-400 hover:underline text-white text-white">âœ¨ AI å®¡è®¡</button>
                        </div>
                    </div>
                </div>

                <section class="bg-slate-800/20 rounded-2xl border border-slate-800 p-6 shadow-inner text-white">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                        <span class="w-1.5 h-4 bg-blue-500 rounded-full text-white"></span>
                        è“ç‰™äº¤äº’é€»è¾‘æ¶æ„ (System Logic Architecture)
                    </h2>
                    <div class="flex flex-col md:flex-row items-stretch justify-between gap-4 relative">
                        <div class="logic-step flex-1">
                            <span class="absolute -top-2 -left-2 bg-blue-600 text-[8px] px-1.5 py-0.5 rounded font-bold text-white">LAYER 1</span>
                            <div class="text-blue-400 mb-2"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></div>
                            <h3 class="text-[10px] font-bold text-white mb-1">ç‰©ç†è®¾å¤‡å±‚</h3>
                            <p class="text-[9px] text-slate-500 leading-tight">è“ç‰™æ‰«ææª (HID) / ä¼ æ„Ÿå™¨ (GATT)</p>
                        </div>
                        <div class="logic-arrow hidden md:flex">â†’</div>
                        <div class="logic-step flex-1 border-emerald-500/30 text-white">
                            <span class="absolute -top-2 -left-2 bg-emerald-600 text-[8px] px-1.5 py-0.5 rounded font-bold text-white">LAYER 2</span>
                            <div class="text-emerald-400 mb-2"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg></div>
                            <h3 class="text-[10px] font-bold text-white mb-1">æ•è·å±‚</h3>
                            <div class="flex flex-col gap-1 mt-1">
                                <span class="bg-slate-900 text-[8px] p-1 rounded text-emerald-500 border border-emerald-500/20">Keyboard Event</span>
                                <span class="bg-slate-900 text-[8px] p-1 rounded text-blue-400 border border-blue-400/20 text-white">GATT Server</span>
                            </div>
                        </div>
                        <div class="logic-arrow hidden md:flex">â†’</div>
                        <div class="logic-step flex-1 border-amber-500/30 text-white">
                            <span class="absolute -top-2 -left-2 bg-amber-600 text-[8px] px-1.5 py-0.5 rounded font-bold text-white">LAYER 3</span>
                            <div class="text-amber-400 mb-2 text-white"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg></div>
                            <h3 class="text-[10px] font-bold text-white mb-1">æ™ºèƒ½è·¯ç”±åˆ†æµ</h3>
                            <p class="text-[8px] text-slate-500 leading-tight">æ­£åˆ™ç­¾ååŒ¹é… <br> åè®®ç›´è¿åˆ†å‘</p>
                        </div>
                        <div class="logic-arrow hidden md:flex">â†’</div>
                        <div class="logic-step flex-1 border-purple-500/30 text-white">
                            <span class="absolute -top-2 -left-2 bg-purple-600 text-[8px] px-1.5 py-0.5 rounded font-bold text-white">LAYER 4</span>
                            <div class="text-purple-400 mb-2"><svg class="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg></div>
                            <h3 class="text-[10px] font-bold text-white mb-1">Gemini AI å®¡è®¡</h3>
                            <p class="text-[9px] text-slate-500 leading-tight">ç‰©ç†æ„ä¹‰è§£æ <br> å¼‚å¸¸æ•°æ®ç›‘æ§</p>
                        </div>
                    </div>
                </section>

                <section class="bg-[#0b0f1a] rounded-2xl border border-slate-800 overflow-hidden shadow-2xl">
                    <div class="bg-slate-800/50 px-5 py-3 flex justify-between items-center border-b border-slate-700">
                        <div class="flex items-center gap-4">
                            <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest text-white">ç»Ÿä¸€æ•°æ®å®¡è®¡æµ (Audit Stream)</span>
                            <span id="speed-tag" class="text-[9px] bg-slate-900 px-2 py-0.5 rounded text-blue-400 border border-blue-900/50 font-mono tracking-tighter">-- MS</span>
                        </div>
                        <button onclick="clearLogs()" class="text-[10px] text-slate-500 hover:text-white transition-colors uppercase font-bold text-white">Clear Logs</button>
                    </div>
                    <div id="audit-log" class="h-80 overflow-y-auto scrollbar-hidden p-0 font-mono text-[11px] text-slate-200 text-white">
                        <div class="p-8 text-center text-slate-700 italic text-[10px]">ç­‰å¾…ç‰©ç†æ•°æ®è§¦å‘æˆ–æ¢æµ‹æŒ‡ä»¤...</div>
                    </div>
                </section>

                <div class="bg-slate-800/30 p-4 rounded-xl border border-slate-800 relative">
                    <div class="flex justify-between items-center mb-2 px-1 text-[10px] font-bold text-slate-500 uppercase tracking-widest text-white">
                        <span>æ€»çº¿å…¥å£ [é”®ç›˜/HID ç»Ÿä¸€æµ]</span>
                        <div id="lock-status-badge" class="hidden flex items-center gap-1.5 px-2.5 py-1 bg-blue-600 rounded-full shadow-lg">
                            <span class="text-[8px] font-black text-white uppercase tracking-wider text-white text-white">å·²å¼ºåˆ¶é”å®šç„¦ç‚¹</span>
                        </div>
                    </div>
                    <input type="text" id="main-input" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-4 text-sm focus:border-blue-500 outline-none transition-all placeholder:text-slate-800 text-white font-mono" placeholder="åœ¨æ­¤å½•å…¥æ•°æ®...">
                </div>
            </div>
        </div>
    </div>

    <script>
        let auditLog, speedTag, mainInput, lockFocusToggle, lockStatusBadge, protocolInfo, envAlertBox;
        let inputBuffer = "";
        let lastEventTime = performance.now();
        let recentIntervals = [];

        function initDOMRefs() {
            auditLog = document.getElementById('audit-log');
            speedTag = document.getElementById('speed-tag');
            mainInput = document.getElementById('main-input');
            lockFocusToggle = document.getElementById('lock-focus-toggle');
            lockStatusBadge = document.getElementById('lock-status-badge');
            protocolInfo = document.getElementById('current-protocol-info');
            envAlertBox = document.getElementById('env-alert-box');
            
            const originLabel = document.getElementById('current-origin-label');
            if (originLabel) originLabel.innerText = window.location.href;
        }

        function performEnvironmentCheck() {
            const isIframe = window.self !== window.top;
            const isSecure = window.isSecureContext;
            const hasBt = !!(navigator.bluetooth);
            const hasGetDevices = hasBt && typeof navigator.bluetooth.getDevices === 'function';

            updateStatusPill('st-https', isSecure);
            updateStatusPill('st-bt', hasBt);
            updateStatusPill('st-persistent', hasGetDevices);

            if (isIframe) {
                addSystemLog("âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°é¡µé¢å¤„äº iframe åµŒå¥—ä¸­ã€‚è¿™é€šå¸¸ä¼šæ‹¦æˆª Bluetooth æƒé™ã€‚è¯·åœ¨ç‹¬ç«‹æµè§ˆå™¨æ ‡ç­¾é¡µæ‰“å¼€åœ°å€ã€‚", "text-amber-400 bg-amber-400/5");
                if (envAlertBox) envAlertBox.classList.remove('hidden');
            }

            if (!isSecure) {
                addSystemLog("âŒ é”™è¯¯ï¼šå½“å‰å¤„äºéå®‰å…¨ä¸Šä¸‹æ–‡ã€‚Web Bluetooth ä»…åœ¨ HTTPS æˆ– Localhost ä¸‹å·¥ä½œã€‚", "text-red-400");
            }
        }

        function updateStatusPill(id, status) {
            const el = document.getElementById(id);
            if (!el) return;
            const dot = el.querySelector('div');
            if (status) {
                if (dot) dot.className = "w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_#10b981]";
                el.classList.add('text-emerald-400');
            } else {
                if (dot) dot.className = "w-1.5 h-1.5 rounded-full bg-red-500";
                el.classList.add('text-red-400');
            }
        }

        function updateBTStatus(connected, name = "") {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (!dot || !text) return; 
            dot.className = connected ? "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]" : "w-2 h-2 rounded-full bg-slate-600";
            text.innerText = connected ? `åœ¨çº¿: ${name}` : "å°±ç»ª";
        }

        // --- è“ç‰™é€»è¾‘ ---

        async function quickReconnect() {
            try {
                addAuditEntry({ key: "Polling persistent devices...", source: "SYSTEM" }, 0, "", "TX");
                
                if (!navigator.bluetooth || !navigator.bluetooth.getDevices) {
                    addSystemLog("API ç¼ºå¤±ï¼šå½“å‰ç¯å¢ƒä¸æ”¯æŒ getDevices()ã€‚å¯èƒ½æ˜¯åœ¨ iframe ä¸­è¿è¡Œå¯¼è‡´çš„æƒé™ç¼ºå¤±ã€‚", "text-amber-400");
                    return;
                }

                const devices = await navigator.bluetooth.getDevices();
                if (devices.length === 0) {
                    addSystemLog("æœªå‘ç°å†å²æˆæƒè®°å½•ã€‚è¯·å…ˆä½¿ç”¨å¸¸è§„è¿æ¥æ–¹å¼æˆæƒä¸€æ¬¡è®¾å¤‡ã€‚", "text-slate-400");
                    return;
                }

                const device = devices[0]; 
                addAuditEntry({ key: `Attempting Auto-Connect: ${device.name}`, source: "SYSTEM" }, 0, "", "TX");
                const server = await device.gatt.connect();
                await handleDeviceServices(device, server);
                updateBTStatus(true, device.name);
            } catch (error) {
                addSystemLog(`é‡è¿å¤±è´¥: ${error.message}`, "text-red-500");
            }
        }

        async function discoveryModeScan() {
            try {
                addAuditEntry({ key: "Requesting Discovery...", source: "BROWSER" }, 0, "", "TX");
                if (!navigator.bluetooth) throw new Error("è“ç‰™ API ä¸å¯ç”¨");

                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['battery_service', 'heart_rate', '0000ffe0-0000-1000-8000-00805f9b34fb', '275ce3d8-b906-4475-8dd7-76af0db742bf']
                });

                const server = await device.gatt.connect();
                await handleDeviceServices(device, server, true);
                updateBTStatus(true, device.name);
            } catch (error) {
                handleBTError(error);
            }
        }

        async function smartFilteredScan() {
            const serviceUuid = document.getElementById('gatt-service-uuid').value.trim();
            if (!serviceUuid) return;
            try {
                addAuditEntry({ key: `Filtering: ${serviceUuid.slice(0,8)}`, source: "BROWSER" }, 0, "", "TX");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [serviceUuid.toLowerCase()] }]
                });
                const server = await device.gatt.connect();
                await handleDeviceServices(device, server);
                updateBTStatus(true, device.name);
            } catch (error) {
                handleBTError(error);
            }
        }

        async function handleDeviceServices(device, server, discoverMode = false) {
            const services = await server.getPrimaryServices();
            for (const service of services) {
                if (discoverMode) {
                    addSystemLog(`Discovered Service: ${service.uuid}`, "text-amber-500");
                    document.getElementById('gatt-service-uuid').value = service.uuid;
                    if (protocolInfo) protocolInfo.innerText = `Svc: ${service.uuid.slice(0, 13)}...`;
                }
                const characteristics = await service.getCharacteristics();
                for (const char of characteristics) {
                    if (char.properties.notify || char.properties.indicate) {
                        if (discoverMode) document.getElementById('gatt-char-uuid').value = char.uuid;
                        await char.startNotifications();
                        char.addEventListener('characteristicvaluechanged', (e) => {
                            const dataView = e.target.value;
                            const uint8 = new Uint8Array(dataView.buffer);
                            let hexStr = Array.from(uint8).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
                            let asciiStr = String.fromCharCode(...uint8.filter(b => b >= 32 && b <= 126));
                            dispatchToUI('c', asciiStr || hexStr);
                            addAuditEntry({ key: asciiStr || "RAW", source: "GATT_PACKET" }, 0, hexStr, "RX");
                        });
                    }
                }
            }
        }

        function handleBTError(error) {
            addAuditEntry({ key: `Fail: ${error.name}`, source: "SYSTEM" }, 0, "", "RX");
            if (error.name === 'SecurityError') {
                addSystemLog("å®‰å…¨ç­–ç•¥æ‹¦æˆªï¼šè¯·ç¡®ä¿ä¸åœ¨åµŒå¥—æ¡†æ¶ä¸­è¿è¡Œã€‚ç›´æ¥åœ¨ç‹¬ç«‹æ ‡ç­¾é¡µæ‰“å¼€ localhost é“¾æ¥ã€‚", "text-red-500 bg-red-500/10 p-2 rounded");
            } else {
                addSystemLog(`æŠ¥é”™: ${error.message}`, "text-red-500");
            }
        }

        // --- é”®ç›˜åˆ†æµé€»è¾‘ ---

        window.addEventListener('keydown', (e) => {
            const now = performance.now();
            const interval = now - lastEventTime;
            lastEventTime = now;
            if (lockFocusToggle && lockFocusToggle.checked && e.key === 'Tab') e.preventDefault();
            recentIntervals.push(parseFloat(interval.toFixed(1)));
            if (recentIntervals.length > 30) recentIntervals.shift();
            if (speedTag) speedTag.innerText = `${interval.toFixed(1)} MS`;
            
            addAuditEntry(e, interval, "HID_EV", "RX");
            
            if (e.key.length === 1 || e.key === 'Enter') {
                if (e.key !== 'Enter') {
                    inputBuffer += e.key;
                } else {
                    processInputBuffer(inputBuffer);
                    inputBuffer = "";
                }
                clearTimeout(window.bufferTimer);
                window.bufferTimer = setTimeout(() => {
                    if (inputBuffer) { processInputBuffer(inputBuffer); inputBuffer = ""; }
                }, 250);
            }
        });

        function processInputBuffer(data) {
            const sigA = document.getElementById('sig-a').value;
            const sigB = document.getElementById('sig-b').value;
            if (sigA && data.startsWith(sigA)) dispatchToUI('a', data);
            else if (sigB && data.startsWith(sigB)) dispatchToUI('b', data);
            else dispatchToUI('d', data);
        }

        function dispatchToUI(id, raw) {
            const card = document.getElementById(`card-${id}`);
            const valBox = document.getElementById(`val-${id}`);
            const tsBox = document.getElementById(`ts-${id}`);
            if (!card || !valBox) return;

            let currentContent = valBox.innerText;
            if (currentContent === "-") currentContent = "";
            const newContent = currentContent + (currentContent ? "\n" : "") + raw;
            valBox.innerText = newContent;
            valBox.scrollTop = valBox.scrollHeight;
            if (tsBox) tsBox.innerText = new Date().toLocaleTimeString();
            card.classList.add('device-active');
            setTimeout(() => card.classList.remove('device-active'), 800);
        }

        function clearPosData(id) {
            const valBox = document.getElementById(`val-${id}`);
            if (valBox) valBox.innerText = "-";
        }

        // --- é€šç”¨è¾…åŠ© ---

        function addAuditEntry(e, interval, rawHex = "", direction = "SYS") {
            if (!auditLog) return;
            if (auditLog.querySelector('.italic')) auditLog.innerHTML = '';
            const row = document.createElement('div');
            row.className = "event-row px-5 py-2 flex items-center justify-between hover:bg-slate-800/30 transition-colors text-slate-400";
            const source = e.source || "HID_KB";
            const labelClass = direction === "TX" ? "label-tx" : (direction === "RX" ? "label-rx" : "label-sys");

            row.innerHTML = `
                <div class="flex items-center gap-4 text-white">
                    <span class="text-slate-700 w-16 text-[9px] font-mono text-white">${new Date().toLocaleTimeString().split(' ')[0]}</span>
                    <span class="w-48 text-left text-white text-[9px] font-bold text-white">
                        <span class="msg-label ${labelClass}">${direction}</span>
                        <span class="text-slate-600 mr-1 opacity-50 uppercase text-white">${source}:</span> 
                        <span>${e.key || 'N/A'}</span>
                    </span>
                </div>
                <div class="flex items-center gap-4 text-right min-w-[120px] text-white">
                    <span class="text-[9px] text-slate-600 font-mono text-white">${rawHex ? 'HEX: ' + rawHex : (interval ? interval.toFixed(1) + 'ms' : '')}</span>
                </div>
            `;
            auditLog.prepend(row);
            if (auditLog.childNodes.length > 50) auditLog.removeChild(auditLog.lastChild);
        }

        function addSystemLog(msg, extraClass = "") {
            if (!auditLog) return;
            const div = document.createElement('div');
            div.className = `px-5 py-1 text-[9px] text-blue-500 bg-blue-500/5 border-l-2 border-blue-500 ${extraClass}`;
            div.innerText = `[LOG] ${msg}`;
            auditLog.prepend(div);
        }

        function clearLogs() { if (auditLog) auditLog.innerHTML = ''; }

        async function analyzeData(id) {
            addSystemLog(`TX: AI Audit Pos ${id.toUpperCase()}`);
            addSystemLog(`RX: AI å®¡è®¡åŠŸèƒ½æ¨¡æ‹Ÿã€‚è¯·é…ç½® API Key ä»¥æ¿€æ´»çœŸå®å®¡è®¡ã€‚`);
        }

        window.onload = () => {
            initDOMRefs();
            updateBTStatus(false);
            performEnvironmentCheck();
            if (mainInput) {
                mainInput.addEventListener('blur', () => {
                    if (lockFocusToggle && lockFocusToggle.checked) setTimeout(() => mainInput.focus(), 10);
                });
            }
        };
    </script>
</body>
</html>
