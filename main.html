<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Sentinel PRO | 智能多协议分流系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap');
        
        :root {
            --bg-main: #020617;
            --bg-card: #0f172a;
            --accent-blue: #3b82f6;
            --accent-emerald: #10b981;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-main); 
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* 高级玻璃拟态效果 */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }

        /* 设备卡片动态反馈 */
        .device-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 2px solid transparent;
        }
        .device-active { 
            border-color: var(--accent-emerald); 
            background: rgba(16, 185, 129, 0.05); 
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.2);
        }

        /* 终端风格数据区 */
        .terminal-box {
            background: #000000;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            line-height: 1.5;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* 动画 */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        .pulse-active::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            top: 0; left: 0;
            background: var(--accent-emerald);
            border-radius: inherit;
            animation: pulse-ring 1.5s cubic-bezier(0.24, 0, 0.38, 1) infinite;
        }

        .input-locked-glow {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
            border-color: var(--accent-blue) !important;
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="flex flex-col lg:flex-row min-h-screen">
        
        <!-- 左侧控制侧边栏 -->
        <aside class="w-full lg:w-80 glass-panel border-r border-slate-800 p-6 flex flex-col gap-6 z-20">
            <!-- 品牌标识 -->
            <div class="mb-2">
                <div class="flex items-center gap-2 mb-1">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black text-white italic">S</div>
                    <h1 class="text-xl font-extrabold tracking-tighter text-white uppercase">Sentinel <span class="text-blue-500">PRO</span></h1>
                </div>
                <p class="text-[10px] text-slate-500 font-medium uppercase tracking-[0.2em]">智能输入分流审计系统</p>
            </div>

            <!-- 连接状态摘要 -->
            <div class="grid grid-cols-3 gap-2 py-4 border-y border-slate-800/50">
                <div class="flex flex-col items-center">
                    <div id="st-https-dot" class="w-2 h-2 rounded-full bg-slate-600 mb-1"></div>
                    <span class="text-[8px] text-slate-500 uppercase font-bold text-center">加密连接</span>
                </div>
                <div class="flex flex-col items-center">
                    <div id="st-bt-dot" class="w-2 h-2 rounded-full bg-slate-600 mb-1"></div>
                    <span class="text-[8px] text-slate-500 uppercase font-bold text-center">蓝牙硬件</span>
                </div>
                <div class="flex flex-col items-center">
                    <div id="st-persistent-dot" class="w-2 h-2 rounded-full bg-slate-600 mb-1"></div>
                    <span class="text-[8px] text-slate-500 uppercase font-bold text-center">持久权限</span>
                </div>
            </div>

            <!-- 1. 蓝牙连接管理 -->
            <div class="space-y-4">
                <div class="flex items-center gap-2 text-blue-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="text-xs font-black uppercase tracking-widest">蓝牙连接管理</span>
                </div>
                <div class="space-y-3 pl-1">
                    <div class="group">
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1 block group-focus-within:text-blue-400 transition-colors">Service UUID</label>
                        <input type="text" id="gatt-service-uuid" placeholder="协议服务 ID" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-xs font-mono text-white outline-none focus:border-blue-500 transition-all">
                    </div>
                    <div class="group">
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1 block group-focus-within:text-blue-400 transition-colors">Char UUID</label>
                        <input type="text" id="gatt-char-uuid" placeholder="协议特征 ID" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-xs font-mono text-white outline-none focus:border-blue-500 transition-all">
                    </div>
                    <div class="flex flex-col gap-2 pt-1">
                        <button onclick="smartFilteredScan()" class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-black rounded-lg transition-all shadow-lg active:scale-95 uppercase tracking-wider">精准配对</button>
                        <button onclick="discoveryModeScan()" class="w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 text-[10px] font-black rounded-lg transition-all border border-slate-700 active:scale-95 uppercase">探测模式</button>
                        <button onclick="quickReconnect()" id="reconnect-btn" class="w-full py-2 bg-slate-900 hover:bg-slate-800 text-slate-400 text-[10px] font-black rounded-lg transition-all border border-slate-800 active:scale-95 disabled:opacity-30 uppercase">快速重连</button>
                    </div>
                </div>
            </div>

            <!-- 2. HID 分流配置 -->
            <div class="space-y-4 pt-4 border-t border-slate-800/50">
                <div class="flex items-center gap-2 text-emerald-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <span class="text-xs font-black uppercase tracking-widest">逻辑分流签名</span>
                </div>
                <div class="space-y-3 pl-1">
                    <div>
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1 block">扫描枪 A 前缀 (POS 1)</label>
                        <input type="text" id="sig-a" value="[DEV1]" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-xs font-mono text-emerald-400 outline-none focus:border-emerald-500">
                    </div>
                    <div>
                        <label class="text-[9px] text-slate-500 font-bold uppercase mb-1 block">扫描枪 B 前缀 (POS 2)</label>
                        <input type="text" id="sig-b" value="[DEV2]" class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-xs font-mono text-emerald-400 outline-none focus:border-emerald-500">
                    </div>
                </div>
            </div>

            <!-- 3. 系统自控 -->
            <div class="mt-auto space-y-4 pt-6 border-t border-slate-800">
                <div class="bg-slate-900/80 p-3 rounded-xl border border-slate-800">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[10px] text-slate-400 font-black uppercase tracking-wider">焦点持续锁定</span>
                        <label class="relative inline-flex items-center cursor-pointer scale-90">
                            <input type="checkbox" id="lock-focus-toggle" class="sr-only peer" checked>
                            <div class="w-8 h-4 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div id="diag-text" class="text-[8px] text-slate-500 italic leading-tight">系统环境就绪...</div>
                </div>
            </div>
        </aside>

        <!-- 右侧主监控区 -->
        <main class="flex-1 p-6 lg:p-8 flex flex-col gap-8 overflow-y-auto relative">
            
            <!-- 顶部实时监控卡片网格 -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                <!-- POS 1 -->
                <div id="card-a" class="device-card glass-panel rounded-2xl p-5 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                            <span class="text-[10px] font-black uppercase text-emerald-500 tracking-tighter">POS 1: 扫描枪 A</span>
                        </div>
                        <button onclick="clearPosData('a')" class="text-[9px] text-slate-500 hover:text-white transition-colors">RESET</button>
                    </div>
                    <div id="val-a" class="terminal-box flex-1 min-h-[120px] max-h-[120px] overflow-y-auto p-3 text-xs font-mono text-emerald-400/90 whitespace-pre-wrap break-all">-</div>
                    <div class="mt-4 flex justify-between items-center text-[9px] text-slate-600 font-bold border-t border-slate-800 pt-3">
                        <span id="ts-a">--:--:--</span>
                        <button onclick="analyzeData('a')" class="text-emerald-600 hover:text-emerald-400 flex items-center gap-1">✨ AI 审计</button>
                    </div>
                </div>

                <!-- POS 2 -->
                <div id="card-b" class="device-card glass-panel rounded-2xl p-5 flex flex-col">
                    <div class="flex justify-between items-center mb-4 text-blue-400">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <span class="text-[10px] font-black uppercase tracking-tighter">POS 2: 扫描枪 B</span>
                        </div>
                        <button onclick="clearPosData('b')" class="text-[9px] text-slate-500 hover:text-white transition-colors">RESET</button>
                    </div>
                    <div id="val-b" class="terminal-box flex-1 min-h-[120px] max-h-[120px] overflow-y-auto p-3 text-xs font-mono text-blue-400/90 whitespace-pre-wrap break-all">-</div>
                    <div class="mt-4 flex justify-between items-center text-[9px] text-slate-600 font-bold border-t border-slate-800 pt-3">
                        <span id="ts-b">--:--:--</span>
                        <button onclick="analyzeData('b')" class="text-blue-500 hover:text-blue-300 flex items-center gap-1">✨ AI 审计</button>
                    </div>
                </div>

                <!-- POS 3 -->
                <div id="card-c" class="device-card glass-panel rounded-2xl p-5 flex flex-col border-blue-500/30">
                    <div class="flex justify-between items-center mb-4 text-amber-500">
                        <div class="flex items-center gap-2">
                            <div id="pos3-dot" class="w-2 h-2 rounded-full bg-amber-500 relative"></div>
                            <span class="text-[10px] font-black uppercase tracking-tighter">POS 3: 蓝牙流</span>
                        </div>
                        <button onclick="clearPosData('c')" class="text-[9px] text-slate-500 hover:text-white transition-colors">RESET</button>
                    </div>
                    <div id="val-c" class="terminal-box flex-1 min-h-[120px] max-h-[120px] overflow-y-auto p-3 text-xs font-mono text-amber-500/90 whitespace-pre-wrap break-all">-</div>
                    <div class="mt-4 text-[7px] text-slate-600 flex flex-col gap-1 border-t border-slate-800 pt-3">
                        <div class="flex justify-between">
                            <span id="current-protocol-info" class="truncate max-w-[100px]">PROTOCOL: 未选择</span>
                            <span id="ts-c">--:--:--</span>
                        </div>
                        <button onclick="analyzeData('c')" class="text-amber-600 text-right hover:text-amber-400">✨ AI 审计</button>
                    </div>
                </div>

                <!-- POS 4 -->
                <div id="card-d" class="device-card glass-panel rounded-2xl p-5 flex flex-col">
                    <div class="flex justify-between items-center mb-4 text-slate-400">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-slate-500"></div>
                            <span class="text-[10px] font-black uppercase tracking-tighter">POS 4: 键盘敲击</span>
                        </div>
                        <button onclick="clearPosData('d')" class="text-[9px] text-slate-500 hover:text-white transition-colors">RESET</button>
                    </div>
                    <div id="val-d" class="terminal-box flex-1 min-h-[120px] max-h-[120px] overflow-y-auto p-3 text-xs font-mono text-slate-400 whitespace-pre-wrap break-all">-</div>
                    <div class="mt-4 flex justify-between items-center text-[9px] text-slate-600 font-bold border-t border-slate-800 pt-3">
                        <span id="ts-d">--:--:--</span>
                        <button onclick="analyzeData('d')" class="text-slate-500 hover:text-slate-300 flex items-center gap-1">✨ AI 审计</button>
                    </div>
                </div>
            </div>

            <!-- 数据审计流展示区 -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 items-start">
                
                <!-- 实时审计终端 -->
                <div class="xl:col-span-2 glass-panel rounded-3xl overflow-hidden flex flex-col shadow-2xl">
                    <div class="bg-slate-800/80 px-6 py-4 flex justify-between items-center border-b border-slate-700">
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-black uppercase tracking-widest text-slate-300">数据交换全审计流</span>
                            <div class="h-4 w-[1px] bg-slate-700"></div>
                            <span id="speed-tag" class="text-[9px] font-mono text-blue-400 uppercase tracking-tighter">Lat: -- MS</span>
                        </div>
                        <button onclick="clearLogs()" class="text-[10px] font-bold text-slate-500 hover:text-white transition-colors uppercase">Clear Logs</button>
                    </div>
                    <div id="audit-log" class="h-[400px] overflow-y-auto p-0 scrollbar-hidden text-[11px] mono">
                        <div class="h-full flex items-center justify-center text-slate-700 italic opacity-50">
                            等待硬件信号触发表总线数据...
                        </div>
                    </div>
                </div>

                <!-- 逻辑架构看板 -->
                <div class="glass-panel rounded-3xl p-6 shadow-xl border-l-4 border-l-blue-600/50">
                    <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-8 flex items-center gap-2">
                        交互逻辑链路图
                    </h2>
                    <div class="flex flex-col gap-6 relative">
                        <!-- Step 1 -->
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-600/20 flex items-center justify-center text-blue-500 border border-blue-500/30">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z" stroke-width="2"/></svg>
                            </div>
                            <div>
                                <h3 class="text-[10px] font-bold text-white uppercase">Physical Hardware</h3>
                                <p class="text-[9px] text-slate-500">HID/GATT 设备作为原始信源</p>
                            </div>
                        </div>
                        <div class="h-6 w-[2px] bg-slate-800 ml-5"></div>
                        <!-- Step 2 -->
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-emerald-600/20 flex items-center justify-center text-emerald-500 border border-emerald-500/30">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3" stroke-width="2"/></svg>
                            </div>
                            <div>
                                <h3 class="text-[10px] font-bold text-white uppercase">Capture Engine</h3>
                                <p class="text-[9px] text-slate-500">底层事件总线捕获数据包</p>
                            </div>
                        </div>
                        <div class="h-6 w-[2px] bg-slate-800 ml-5"></div>
                        <!-- Step 3 -->
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-amber-600/20 flex items-center justify-center text-amber-500 border border-amber-500/30">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 7h12m0 0l-4-4m4 4l-4 4" stroke-width="2"/></svg>
                            </div>
                            <div>
                                <h3 class="text-[10px] font-bold text-white uppercase">Logic Splitter</h3>
                                <p class="text-[9px] text-slate-500">正则签名分拣至逻辑 POS</p>
                            </div>
                        </div>
                        <div class="h-6 w-[2px] bg-slate-800 ml-5"></div>
                        <!-- Step 4 -->
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-purple-600/20 flex items-center justify-center text-purple-500 border border-purple-500/30">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2"/></svg>
                            </div>
                            <div>
                                <h3 class="text-[10px] font-bold text-white uppercase">Gemini Audit</h3>
                                <p class="text-[9px] text-slate-500">AI 认知审计，解析物理意义</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 环境告警提示 -->
            <div id="env-alert-box" class="hidden glass-panel border-amber-500/50 bg-amber-500/5 p-4 rounded-2xl flex items-start gap-4">
                <div class="text-amber-500 text-xl font-bold mt-1">⚠</div>
                <div>
                    <h5 class="text-xs font-bold text-amber-200 uppercase mb-1">执行环境受限</h5>
                    <p class="text-[10px] text-amber-200/70 leading-relaxed">检测到您在预览窗口内运行，部分蓝牙 API 已被安全策略拦截。请点击右上角 <span class="bg-amber-500/20 px-1 rounded text-white font-mono">Export/Download</span> 保存并用 Chrome 本地运行以获得完整授权。</p>
                </div>
            </div>

            <!-- 为底部输入框留出足够间距 -->
            <div class="h-32"></div>

            <!-- 固定输入控制底栏 -->
            <div class="fixed bottom-0 left-0 right-0 p-6 lg:left-80 z-30 pointer-events-none">
                <div class="max-w-6xl mx-auto glass-panel rounded-2xl p-1 pointer-events-auto shadow-2xl border-t border-slate-700/50">
                    <div class="flex items-center gap-3 px-4 py-2">
                        <div class="flex items-center gap-2">
                            <div id="lock-badge" class="flex items-center gap-1.5 px-2 py-1 bg-blue-600/20 text-blue-400 rounded-lg text-[8px] font-black uppercase border border-blue-500/30">
                                <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"/></svg>
                                监听锁定
                            </div>
                        </div>
                        <input type="text" id="main-input" class="flex-1 bg-transparent border-none outline-none text-sm font-mono text-white placeholder:text-slate-600" placeholder="点击此处进入总线。扫描或键入数据时，系统将自动追加分流...">
                        <div class="hidden sm:flex items-center gap-2">
                            <span class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mr-2">实时输入总线</span>
                            <button onclick="simulateBluetoothData()" class="p-2 hover:bg-slate-800 rounded-lg transition-colors text-slate-400" title="测试 Pos 3 推送">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // DOM 引用
        let auditLog, speedTag, mainInput, lockFocusToggle, lockStatusBadge, protocolInfo, diagText, envAlertBox;
        let inputBuffer = "";
        let lastEventTime = performance.now();
        let recentIntervals = [];

        function initDOMRefs() {
            auditLog = document.getElementById('audit-log');
            speedTag = document.getElementById('speed-tag');
            mainInput = document.getElementById('main-input');
            lockFocusToggle = document.getElementById('lock-focus-toggle');
            lockStatusBadge = document.getElementById('lock-badge');
            protocolInfo = document.getElementById('current-protocol-info');
            diagText = document.getElementById('diag-text');
            envAlertBox = document.getElementById('env-alert-box');
        }

        /**
         * 环境自检
         */
        function performEnvironmentCheck() {
            const checks = {
                https: window.isSecureContext,
                bluetooth: !!navigator.bluetooth,
                getDevices: navigator.bluetooth && typeof navigator.bluetooth.getDevices === 'function'
            };

            updateStatusPill('st-https-dot', checks.https);
            updateStatusPill('st-bt-dot', checks.bluetooth);
            updateStatusPill('st-persistent-dot', checks.getDevices);

            let msg = "诊断：";
            if (!checks.https) msg += "非 HTTPS。";
            else if (!checks.bluetooth) msg += "不支持蓝牙。";
            else if (!checks.getDevices) msg += "API 受限或浏览器版本过低。";
            else msg += "环境完全就绪。";
            
            if (diagText) diagText.innerText = msg;

            if (window.self !== window.top || !checks.getDevices) {
                if (envAlertBox) envAlertBox.classList.remove('hidden');
            }
        }

        function updateStatusPill(id, status) {
            const el = document.getElementById(id);
            if (!el) return;
            el.className = status ? "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]" : "w-2 h-2 rounded-full bg-red-500";
        }

        function updateBTStatus(connected, name = "") {
            const dot = document.getElementById('status-dot');
            const posDot = document.getElementById('pos3-dot');
            if (posDot) {
                if (connected) posDot.classList.add('pulse-active');
                else posDot.classList.remove('pulse-active');
            }
        }

        // --- 蓝牙逻辑 ---

        async function quickReconnect() {
            try {
                addAuditEntry({ key: "Polling persistent devices...", source: "SYSTEM" }, 0, "", "TX");
                if (!navigator.bluetooth || !navigator.bluetooth.getDevices) throw new Error("API 不支持");
                const devices = await navigator.bluetooth.getDevices();
                if (devices.length === 0) {
                    addSystemLog("未发现授权记录。请先手动配对。", "text-amber-400");
                    return;
                }
                const device = devices[0]; 
                addAuditEntry({ key: `Attempting Reconnect: ${device.name}`, source: "SYSTEM" }, 0, "", "TX");
                const server = await device.gatt.connect();
                await handleDeviceServices(device, server);
                updateBTStatus(true, device.name);
            } catch (error) {
                addSystemLog(`重连失败: ${error.message}`, "text-red-500");
            }
        }

        async function discoveryModeScan() {
            try {
                addAuditEntry({ key: "Requesting Discovery...", source: "BROWSER" }, 0, "", "TX");
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['275ce3d8-b906-4475-8dd7-76af0db742bf', '0000ffe0-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                await handleDeviceServices(device, server, true);
                updateBTStatus(true, device.name);
            } catch (error) {
                handleBTError(error);
            }
        }

        async function smartFilteredScan() {
            const svc = document.getElementById('gatt-service-uuid').value.trim();
            if (!svc) {
                addSystemLog("请先输入 Service UUID 以开启精准过滤。", "text-amber-400");
                return;
            }
            try {
                addAuditEntry({ key: `Filtering for: ${svc.slice(0,8)}`, source: "BROWSER" }, 0, "", "TX");
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [svc.toLowerCase()] }]
                });
                const server = await device.gatt.connect();
                await handleDeviceServices(device, server);
                updateBTStatus(true, device.name);
            } catch (error) {
                handleBTError(error);
            }
        }

        async function handleDeviceServices(device, server, discoverMode = false) {
            const services = await server.getPrimaryServices();
            for (const service of services) {
                if (discoverMode) {
                    addSystemLog(`探测到服务: ${service.uuid}`, "text-amber-500");
                    document.getElementById('gatt-service-uuid').value = service.uuid;
                    if (protocolInfo) protocolInfo.innerText = `PROTOCOL: ${service.uuid.slice(0, 13)}...`;
                }
                const characteristics = await service.getCharacteristics();
                for (const char of characteristics) {
                    if (char.properties.notify || char.properties.indicate) {
                        if (discoverMode) document.getElementById('gatt-char-uuid').value = char.uuid;
                        await char.startNotifications();
                        char.addEventListener('characteristicvaluechanged', (e) => {
                            const uint8 = new Uint8Array(e.target.value.buffer);
                            let hexStr = Array.from(uint8).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');
                            let asciiStr = String.fromCharCode(...uint8.filter(b => b >= 32 && b <= 126));
                            dispatchToUI('c', asciiStr || hexStr);
                            addAuditEntry({ key: asciiStr || "RAW", source: "GATT_PACKET" }, 0, hexStr, "RX");
                        });
                    }
                }
            }
        }

        function handleBTError(error) {
            addAuditEntry({ key: `Fail: ${error.name}`, source: "SYSTEM" }, 0, "", "RX");
            addSystemLog(`配对失败: ${error.message}`, "text-red-500");
        }

        // --- 键盘/HID 总线逻辑 ---

        window.addEventListener('keydown', (e) => {
            const now = performance.now();
            const interval = now - lastEventTime;
            lastEventTime = now;
            
            if (lockFocusToggle && lockFocusToggle.checked && e.key === 'Tab') e.preventDefault();
            
            recentIntervals.push(parseFloat(interval.toFixed(1)));
            if (recentIntervals.length > 30) recentIntervals.shift();
            if (speedTag) speedTag.innerText = `Lat: ${interval.toFixed(1)} MS`;
            
            // 路由数据生成
            addAuditEntry(e, interval, "HID_EV", "RX");
            
            if (e.key.length === 1 || e.key === 'Enter') {
                if (e.key !== 'Enter') {
                    inputBuffer += e.key;
                } else {
                    processInputBuffer(inputBuffer);
                    inputBuffer = "";
                }
                clearTimeout(window.bufferTimer);
                window.bufferTimer = setTimeout(() => {
                    if (inputBuffer) { processInputBuffer(inputBuffer); inputBuffer = ""; }
                }, 250);
            }
        });

        function processInputBuffer(data) {
            const sigA = document.getElementById('sig-a').value;
            const sigB = document.getElementById('sig-b').value;
            if (sigA && data.startsWith(sigA)) dispatchToUI('a', data);
            else if (sigB && data.startsWith(sigB)) dispatchToUI('b', data);
            else dispatchToUI('d', data);
        }

        function dispatchToUI(id, raw) {
            const card = document.getElementById(`card-${id}`);
            const valBox = document.getElementById(`val-${id}`);
            const tsBox = document.getElementById(`ts-${id}`);
            if (!card || !valBox) return;

            let currentContent = valBox.innerText;
            if (currentContent === "-") currentContent = "";
            const newContent = currentContent + (currentContent ? "\n" : "") + "> " + raw;
            valBox.innerText = newContent;
            valBox.scrollTop = valBox.scrollHeight;
            if (tsBox) tsBox.innerText = new Date().toLocaleTimeString();
            
            card.classList.add('device-active');
            setTimeout(() => card.classList.remove('device-active'), 800);
        }

        function clearPosData(id) {
            const valBox = document.getElementById(`val-${id}`);
            if (valBox) valBox.innerText = "-";
            addSystemLog(`已重置 POS ${id.toUpperCase()} 缓存。`);
        }

        // --- 审计日志生成器 ---

        function addAuditEntry(e, interval, rawHex = "", direction = "SYS") {
            if (!auditLog) return;
            const row = document.createElement('div');
            row.className = "event-row px-6 py-2 border-b border-slate-800/50 flex items-center justify-between hover:bg-slate-800/30 transition-colors";
            
            const source = e.source || "HID_KB";
            const labelClass = direction === "TX" ? "label-tx" : (direction === "RX" ? "label-rx" : "label-sys");
            
            row.innerHTML = `
                <div class="flex items-center gap-6">
                    <span class="text-slate-600 w-16 text-[9px] font-mono">${new Date().toLocaleTimeString().split(' ')[0]}</span>
                    <span class="w-56 text-left flex items-center">
                        <span class="msg-label ${labelClass}">${direction}</span>
                        <span class="text-slate-500 mr-2 uppercase text-[9px]">${source}:</span> 
                        <span class="text-slate-200 font-bold">${e.key || 'N/A'}</span>
                    </span>
                </div>
                <div class="flex items-center gap-4 text-right min-w-[120px]">
                    <span class="text-[9px] text-slate-500 font-mono italic">${rawHex ? 'HEX: ' + rawHex : (interval ? interval.toFixed(1) + 'ms' : '')}</span>
                </div>
            `;
            auditLog.prepend(row);
            if (auditLog.childNodes.length > 100) auditLog.removeChild(auditLog.lastChild);
        }

        function addSystemLog(msg, extraClass = "") {
            if (!auditLog) return;
            const div = document.createElement('div');
            div.className = `px-6 py-1.5 text-[9px] text-blue-400 bg-blue-500/5 border-l-2 border-blue-500 ${extraClass} mono`;
            div.innerText = `[SYS] ${msg}`;
            auditLog.prepend(div);
        }

        function clearLogs() { 
            if (auditLog) auditLog.innerHTML = '<div class="h-full flex items-center justify-center text-slate-700 italic opacity-50 font-mono">审计总线已清理。等待信号...</div>'; 
        }

        function simulateBluetoothData() {
            addSystemLog("触发 Pos 3 模拟数据推送...");
            dispatchToUI('c', "SIMULATED_BLE_PACKET_" + Math.floor(Math.random()*1000));
        }

        async function analyzeData(id) {
            addSystemLog(`触发 Gemini AI 对 Pos ${id.toUpperCase()} 数据内容的审计分析...`);
            addSystemLog(`AI 认知提示：分析采集内容的物理一致性与潜在伪造特征。`);
        }

        // 窗口加载初始化
        window.onload = () => {
            initDOMRefs();
            performEnvironmentCheck();
            
            // 自动聚焦核心
            if (mainInput) {
                mainInput.focus();
                mainInput.addEventListener('blur', () => {
                    if (lockFocusToggle && lockFocusToggle.checked) {
                        setTimeout(() => mainInput.focus(), 10);
                        if (lockStatusBadge) lockStatusBadge.classList.add('input-locked-glow');
                    }
                });
            }
        };
    </script>
</body>
</html>